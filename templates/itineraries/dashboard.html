{# templates/itineraries/dashboard.html #}
{% extends "base.html" %}
{% load static %}
{% load markdownify %}

{% block content %}
<div class="container-fluid" style="background-color:#2C2C2E">
  <div class="row full-height-row">

    {# =====================  PAINEL ESQUERDO ‚Äì Formul√°rio  ===================== #}
    <div class="col-md-4 left-panel d-flex align-items-start flex-column p-4">
      <h3 class="text-white">Criar Novo Itiner√°rio</h3>

      {% if form.errors %}
      <div class="alert alert-danger w-100">
        <ul class="mb-0">
          {% for field, errors in form.errors.items %}
            {% for error in errors %}
              <li><strong>{{ field }}:</strong> {{ error }}</li>
            {% endfor %}
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <form method="POST" action="{% url 'dashboard' %}" class="w-100 needs-validation" novalidate id="itineraryForm">
        {% csrf_token %}
      
        <!-- Destino -->
        <div class="mb-3">
          <label for="destination" class="form-label">Destino *</label>
          <input type="text" class="form-control" id="destination" name="destination"
                 placeholder="Ex: Natal, Brasil" required>
          <div class="form-text">Informe uma cidade, pa√≠s ou regi√£o que deseja visitar.</div>
        </div>
      
        <!-- Datas -->
        <div class="row g-2 mb-3">
          <div class="col">
            <label for="startDate" class="form-label">Data de In√≠cio *</label>
            <input type="date" class="form-control" id="startDate" name="start_date" required>
          </div>
          <div class="col">
            <label for="endDate" class="form-label">Data de T√©rmino *</label>
            <input type="date" class="form-control" id="endDate" name="end_date" required>
          </div>
        </div>
      
        <!-- Or√ßamento -->
        <div class="mb-3">
          <label for="budget" class="form-label">Or√ßamento Total (R$)</label>
          <input type="number" class="form-control" id="budget" name="budget" step="0.01"
                 placeholder="Ex: 2000">
          <div class="form-text">Quanto pretende gastar no total da viagem?</div>
        </div>
      
        <!-- N¬∫ de viajantes -->
        <div class="mb-3">
          <label for="travelers" class="form-label">N√∫mero de Viajantes</label>
          <input type="number" class="form-control" id="travelers" name="travelers" min="1" value="1">
        </div>
      
        <!-- Interesses -->
        <div class="mb-3">
          <label class="form-label d-block">Interesses na Viagem</label>
          <div class="row">
            {% for interest in interests %}
            <div class="col-md-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="interest{{ interest }}"
                       name="interests_list" value="{{ interest }}">
                <label class="form-check-label" for="interest{{ interest }}">{{ interest }}</label>
              </div>
            </div>
            {% endfor %}
          </div>
          <div class="form-text">Voc√™ pode escolher v√°rios temas que deseja focar durante a viagem.</div>
        </div>
    
      
        
      
        <!-- Campo extra opcional -->
        <div class="mb-3">
          <label for="extras" class="form-label">Algo que devemos considerar?</label>
          <textarea class="form-control" id="extras" name="extras" rows="3"
                    placeholder="Ex: Acessibilidade, evitar praias, hot√©is 4 estrelas, etc."
                    style="::placeholder { color: white; }"></textarea>
        </div>
      
        <div class="text-center">
          <button type="submit" class="btn btn-primary w-100 btn-lg shadow-sm">Gerar Roteiro</button>
        </div>
      </form>
      
    </div>

    {# =====================  PAINEL DIREITO ‚Äì Itiner√°rios  ===================== #}
    <div class="col-md-8 px-3 right-panel">
      <h3 class="mb-4 pt-3 text-white">Meus Itiner√°rios</h3>

      {% if itineraries %}
      <div class="row p-3">
        {% for it in itineraries %}
        <div class="col-md-6 mb-4">
          <div class="card h-100 p-3" style="background-color:#2c2c2e;color:#fff;">
            <div class="card-body">
              <h3 class="card-title">{{ it.destination }}</h3>
              <p class="card-text">{{ it.start_date }} ‚Üí {{ it.end_date }}</p>

              <div class="my-2">
                <form method="POST" action="{% url 'delete_itinerary' it.id %}" style="display:inline;">
                  {% csrf_token %}
                  <button class="btn btn-sm btn-outline-light" type="button"
                          data-bs-toggle="modal" data-bs-target="#modalIt{{ it.id }}">
                    Ver Detalhes
                  </button>
                  <a href="{% url 'export_itinerary_pdf' it.id %}"
                     class="btn btn-sm btn-outline-light">Baixar PDF</a>
                  <button type="submit" class="btn btn-sm btn-outline-danger"
                          onclick="return confirm('Tem certeza que deseja excluir este itiner√°rio?')">
                    Excluir
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>

        {# ----------  MODAL DE DETALHES  ---------- #}
        <div class="modal fade" id="modalIt{{ it.id }}" tabindex="-1"
             aria-labelledby="modalItLabel{{ it.id }}" aria-hidden="true">
          <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content" style="background-color:#202023;color:#fff;">
              <div class="modal-header">
                <h5 class="modal-title" id="modalItLabel{{ it.id }}">
                  {{ it.destination }} - {{ it.start_date }} ‚Üí {{ it.end_date }}
                </h5>
                <button type="button" class="btn-close btn-close-white"
                        data-bs-dismiss="modal" aria-label="Close"></button>
              </div>

              <div class="modal-body">
                <h5>Overview</h5>
                <div class="ai-text mb-3">{{ it.generated_text|markdownify }}</div>

                <h5>Days</h5>
                <ul class="nav nav-tabs mt-3" id="daysTab{{ it.id }}" role="tablist">
                  {% for d in it.days.all|dictsort:"day_number" %}
                  <li class="nav-item" role="presentation">
                    <button class="nav-link {% if forloop.first %}active{% endif %}"
                            id="day{{ it.id }}-{{ d.id }}-tab"
                            data-bs-toggle="tab" data-bs-target="#day{{ it.id }}-{{ d.id }}"
                            type="button" role="tab">
                      Dia {{ d.day_number }}
                    </button>
                  </li>
                  {% endfor %}
                </ul>

                <div class="tab-content mt-3" id="daysTabContent{{ it.id }}">
                  {% for d in it.days.all|dictsort:"day_number" %}
                  <div class="tab-pane fade {% if forloop.first %}show active{% endif %}"
                       id="day{{ it.id }}-{{ d.id }}" role="tabpanel">
                    <div class="result-card mb-3">
                      <div class="ai-text" data-dayid="{{ d.id }}">{{ d.generated_text|markdownify|safe }}
                      </div>
                      {# opcional: fallback, pode deixar ou remover #}
                      <div class="places-photo-gallery" id="photos-for-day-{{ d.id }}"></div>


                      {% if d.places_visited %}
                      <div class="mt-3">
                        <strong>Lugares (Editar individualmente):</strong>
                        <div id="day-places-{{ d.id }}" data-places='{{ d.places_visited|safe }}'></div>

                        <script>
                          (function(){
                            const container = document.getElementById("day-places-{{ d.id }}");
                            const rawData = `{{ d.places_visited|safe }}`;
                            try {
                              const arr = JSON.parse(rawData);
                              if (Array.isArray(arr)) {
                                let html = "";
                                arr.forEach((p, idx) => {
                                  const name = p.name || "Local desconhecido";
                                  html += `
                                    <div class="mt-2">
                                      ${idx+1}. ${name}
                                      <button class="btn btn-sm btn-link text-warning replace-place-btn"
                                              data-dayid="{{ d.id }}" data-index="${idx}"
                                              data-bs-toggle="modal" data-bs-target="#replaceModal">
                                        üîÑ
                                      </button>
                                    </div>`;
                                });
                                container.innerHTML = html;
                              }
                            } catch(e){}
                          })();
                        </script>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  {% endfor %}
                </div>

                <h5>Map</h5>
                <div id="map{{ it.id }}"
                     data-lat="{{ it.lat|floatformat:'6' }}"
                     data-lng="{{ it.lng|floatformat:'6' }}"
                     data-markers='{{ it.markers_json|escape }}'
                     style="height:400px; border:1px solid #3a3a3c; border-radius:6px;"></div>
              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-outline-light"
                        data-bs-dismiss="modal">Fechar</button>
              </div>
            </div>
          </div>
        </div>
        {# ----------  /MODAL DE DETALHES  ---------- #}
        {% endfor %}
      </div>
      {% else %}
        <p class="text-white">Nenhum itiner√°rio criado ainda...</p>
      {% endif %}
    </div>
  </div>
</div>

{# ===================  MODAL TROCA DE LUGAR  =================== #}
<div class="modal fade" id="replaceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" style="color:#fff;">
    <div class="modal-content" style="background-color:#202023;">
      <div class="modal-header">
        <h5 class="modal-title">Trocar Lugar</h5>
        <button type="button" class="btn-close btn-close-white"
                data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{% url 'replace_place' %}">
        {% csrf_token %}
        <div class="modal-body">
          <input type="hidden" id="replaceDayId" name="day_id">
          <input type="hidden" id="replaceIndex" name="place_index">
          <div class="mb-3">
            <label for="replaceObservation" class="form-label">
              Observa√ß√£o / Prefer√™ncia para o novo local
            </label>
            <textarea class="form-control" id="replaceObservation" name="observation"
                      rows="3" placeholder="Ex: Quero algo mais central, sem repetir lugares ou com comida t√≠pica"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-light"
                  data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Confirmar Troca</button>
        </div>
      </form>
    </div>
  </div>
</div>

{# ===================  LOADING OVERLAY  =================== #}
<div id="loadingOverlay" style="display:none;">
  <div class="loading-backdrop"></div>
  <div class="loading-box text-center">
    <div class="spinner-border text-light" role="status" style="width:4rem; height:4rem;"></div>
    <div class="progress mt-4" style="height:10px;">
      <div id="loadingBar" class="progress-bar bg-primary" role="progressbar" style="width:0%;"></div>
    </div>
    <p id="loadingText" class="mt-3 fs-5 text-white">Preparando roteiro...</p>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  /* üîÑ 1. Fun√ß√£o utilit√°ria para remover acentos */
  function normalizeText(str) {
    return str
      .normalize("NFD")                 // separa letras de acentos
      .replace(/[\u0300-\u036f]/g, "") // remove acentos
      .toLowerCase()
      .trim();
  }
  
  /* üîÑ 2. Substitua a fun√ß√£o inteira por esta vers√£o */
  function insertPhotoAfterPlace(dayId, placeName, photoUrl) {
    const aiDiv = document.querySelector(`.ai-text[data-dayid="${dayId}"]`);
    if (!aiDiv) return;
  
    const target = normalizeText(placeName);
    const blocks = aiDiv.querySelectorAll("p, li");
  
    for (const el of blocks) {
      if (normalizeText(el.textContent).includes(target)) {
        /* evita duplicar caso j√° tenha imagem */
        if (!el.nextElementSibling || !el.nextElementSibling.classList?.contains("place-photo")) {
          el.insertAdjacentHTML(
            "afterend",
            `<img src="${photoUrl}"
                  alt="Foto de ${placeName}"
                  class="place-photo">`
          );
        }
        return; // encontrou, sai da fun√ß√£o
      }
    }
  
    /* fallback se n√£o achar o par√°grafo */
    const fallback = document.getElementById("photos-for-day-" + dayId);
    if (fallback) {
      fallback.insertAdjacentHTML(
        "beforeend",
        `<img src="${photoUrl}" class="place-photo">`
      );
    }
  }
  </script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  // Loader animation
  const form = document.getElementById("itineraryForm");
  const overlay = document.getElementById("loadingOverlay");
  const bar = document.getElementById("loadingBar");
  const text = document.getElementById("loadingText");

  const messages = [
    "Analisando destino...",
    "Selecionando melhores locais...",
    "Otimizando rotas...",
    "Planejando experi√™ncias √∫nicas...",
    "Gerando roteiro perfeito..."
  ];

  let progress = 0;
  let msgIndex = 0;
  let interval;

  document.querySelectorAll('[id^="photos-for-day-"]').forEach(div => {
    const dayId = div.id.replace("photos-for-day-", "");
    const dataElement = document.getElementById("day-places-" + dayId);
    if (dataElement) {
      const raw = dataElement.dataset.places;
      if (raw) {
        fetchPhotosForPlaces(dayId, raw);
      }
    }
  });

  function startLoadingAnimation() {
    overlay.style.display = "flex";
    progress = 0;
    msgIndex = 0;
    text.textContent = messages[0];
    bar.style.width = "0%";

    interval = setInterval(() => {
      progress += Math.random() * 5;
      bar.style.width = `${Math.min(progress, 100)}%`;

      if (progress >= 20 && msgIndex < 1) {
        text.textContent = messages[1];
        msgIndex = 1;
      }
      if (progress >= 40 && msgIndex < 2) {
        text.textContent = messages[2];
        msgIndex = 2;
      }
      if (progress >= 60 && msgIndex < 3) {
        text.textContent = messages[3];
        msgIndex = 3;
      }
      if (progress >= 80 && msgIndex < 4) {
        text.textContent = messages[4];
        msgIndex = 4;
      }
    }, 400);
  }

  if (form) {
    form.addEventListener("submit", function () {
      startLoadingAnimation();
    });
  }
});



function initAutocomplete() {
  console.log("[initAutocomplete] Chamado: Autocomplete configurado no campo de destino.");
  const destInput = document.getElementById("destination");
  if (destInput) {
    const autocomplete = new google.maps.places.Autocomplete(destInput, { types: ['(cities)'] });
  }

  document.querySelectorAll('.modal.fade').forEach(modal => {
    modal.addEventListener('shown.bs.modal', () => {
      const id = modal.getAttribute('id');
      if (id && id.startsWith("modalIt")) {
        const itineraryId = id.replace('modalIt', '');
        initMultipleMarkers(itineraryId);
      }
    });
  });
}

function initMultipleMarkers(itineraryId) {
  const mapDiv = document.getElementById("map" + itineraryId);
  if (!mapDiv) return;

  const rawMarkers = mapDiv.dataset.markers;
  if (!rawMarkers) return;

  let markers = [];
  try {
    markers = JSON.parse(rawMarkers);
  } catch(e) {
    console.error("[initMultipleMarkers] JSON inv√°lido:", e);
    return;
  }
  if (!markers.length) return;

  let lat = parseFloat(mapDiv.dataset.lat);
  let lng = parseFloat(mapDiv.dataset.lng);
  if (isNaN(lat) || isNaN(lng)) { lat = markers[0].lat; lng = markers[0].lng; }

  const map = new google.maps.Map(mapDiv, { zoom: 12, center: { lat, lng } });
  const bounds = new google.maps.LatLngBounds();

  markers.forEach(m => {
    if (m.lat && m.lng) {
      const pos = { lat: m.lat, lng: m.lng };
      new google.maps.Marker({ position: pos, map, title: m.name });
      bounds.extend(pos);
    }
  });
  if (markers.length > 1) map.fitBounds(bounds);
}

document.addEventListener("DOMContentLoaded", () => {
  const autoOpenId = "{{ new_itinerary_id|default:'' }}";
  if (autoOpenId) {
    const modalEl = document.getElementById("modalIt" + autoOpenId);
    if (modalEl) new bootstrap.Modal(modalEl).show();
  }

  document.body.addEventListener("click", (e) => {
    if (e.target && e.target.classList.contains("replace-place-btn")) {
      document.getElementById("replaceDayId").value = e.target.dataset.dayid;
      document.getElementById("replaceIndex").value = e.target.dataset.index;
      document.getElementById("replaceObservation").value = "";
    }
  });
});

function fetchPhotosForPlaces(dayId, placesJson) {
  let places;
  try { places = JSON.parse(placesJson); } catch { return; }

  const destination =
    document.querySelector(`.ai-text[data-dayid="${dayId}"]`)
            ?.closest(".modal-content")
            ?.querySelector(".modal-title")
            ?.textContent
            ?.split(" - ")[0] || "";

  places.forEach(place => {
    const query = `${place.name}, ${destination}`;
    const googleUrl =
      `https://maps.googleapis.com/maps/api/place/findplacefromtext/json` +
      `?input=${encodeURIComponent(query)}` +
      `&inputtype=textquery&fields=photos&key={{ googlemaps_key }}`;

    fetch("{% url 'proxy_google_places' %}?url=" + encodeURIComponent(googleUrl))
      .then(r => r.json())
      .then(data => {
        let photoUrl;

        // 1Ô∏è‚É£ tenta Google
        const ref = data.candidates?.[0]?.photos?.[0]?.photo_reference;
        if (ref) {
          photoUrl = "{% url 'proxy_google_photo' %}?photo_ref=" + ref;
        } else {
          // 2Ô∏è‚É£ fallback Unsplash (n√£o requer chave)
          photoUrl =
            `https://source.unsplash.com/600x400/?${encodeURIComponent(place.name + ' ' + destination)}`;
        }

        insertPhotoAfterPlace(dayId, place.name, photoUrl);
      })
      .catch(err => console.error("Foto:", err));
  });
}

function insertPhotoAfterPlace(dayId, placeName, photoUrl) {
  const aiDiv = document.querySelector(`.ai-text[data-dayid="${dayId}"]`);
  if (!aiDiv) return;

  const blocks = aiDiv.querySelectorAll("p, li");
  for (const el of blocks) {
    if (el.textContent.toLowerCase().includes(placeName.toLowerCase())) {
      el.insertAdjacentHTML(
        "afterend",
        `<img src="${photoUrl}" alt="Foto de ${placeName}" class="place-photo">`
      );
      return;
    }
  }

  // fallback: fim do dia
  const fallback = document.getElementById("photos-for-day-" + dayId);
  if (fallback) {
    fallback.insertAdjacentHTML(
      "beforeend",
      `<img src="${photoUrl}" class="place-photo">`
    );
  }
}





</script>

<script src="https://maps.googleapis.com/maps/api/js?key={{ googlemaps_key }}&libraries=places&callback=initAutocomplete" async defer></script>
{% endblock %}
