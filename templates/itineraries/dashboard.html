{# templates/itineraries/dashboard.html #}
{% extends "base.html" %}
{% load static %}
{% load markdownify %}

{% block content %}
<div class="container-fluid" style="background-color:#2C2C2E">
  <div class="row full-height-row">

    {# =====================  PAINEL ESQUERDO  ===================== #}
    <div class="col-md-4 left-panel d-flex align-items-start flex-column p-4">
      <h3 class="text-white">Criar Novo Itinerário</h3>

      {% if form.errors %}
      <div class="alert alert-danger w-100">
        <ul class="mb-0">
          {% for field, errors in form.errors.items %}
            {% for error in errors %}
              <li><strong>{{ field }}:</strong> {{ error }}</li>
            {% endfor %}
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <form method="POST" action="{% url 'dashboard' %}" class="w-100 needs-validation" novalidate>
        {% csrf_token %}

        <!-- Destino -->
        <div class="mb-3">
          <label for="destination" class="form-label">Destino *</label>
          <input type="text" class="form-control" id="destination" name="destination"
                 placeholder="Ex: Natal, Brasil" required>
          <div class="form-text">Informe uma cidade/país ou região principal que deseja visitar.</div>
        </div>

        <!-- Datas -->
        <div class="row g-2 mb-3">
          <div class="col">
            <label for="startDate" class="form-label">Data Início *</label>
            <input type="date" class="form-control" id="startDate" name="start_date" required>
          </div>
          <div class="col">
            <label for="endDate" class="form-label">Data Final *</label>
            <input type="date" class="form-control" id="endDate" name="end_date" required>
          </div>
        </div>

        <!-- Orçamento e Viajantes -->
        <div class="row g-2 mb-3">
          <div class="col">
            <label for="budget" class="form-label">Orçamento (R$) *</label>
            <input type="number" class="form-control" id="budget" name="budget" step="0.01"
                   placeholder="Ex: 2000" required>
            <div class="form-text">Valor total estimado para a viagem.</div>
          </div>
          <div class="col">
            <label for="travelers" class="form-label">Nº de Viajantes</label>
            <input type="number" class="form-control" id="travelers" name="travelers" min="1" value="1">
          </div>
        </div>

        <!-- Interesses -->
        <div class="mb-3">
          <label class="form-label d-block">Interesses Principais</label>
          <div class="d-flex flex-wrap gap-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="interestCultura"
                     name="interests_list" value="Cultura">
              <label class="form-check-label" for="interestCultura">Cultura</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="interestGastronomia"
                     name="interests_list" value="Gastronomia">
              <label class="form-check-label" for="interestGastronomia">Gastronomia</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="interestAventura"
                     name="interests_list" value="Aventura">
              <label class="form-check-label" for="interestAventura">Aventura</label>
            </div>
          </div>
          <div class="form-text">
            Selecione quantos quiser: cultura, gastronomia, aventura, compras, natureza, etc.
          </div>
        </div>

        <!-- Alimentação -->
        <div class="mb-3">
          <label for="foodPreferences" class="form-label">Alimentação</label>
          <select class="form-select" id="foodPreferences" name="food_preferences">
            <option value="nenhuma">Nenhuma Restrição</option>
            <option value="vegana">Vegana</option>
            <option value="vegetariana">Vegetariana</option>
            <option value="kosher">Kosher</option>
            <option value="halal">Halal</option>
          </select>
        </div>

        <!-- Transporte -->
        <div class="mb-3">
          <label class="form-label">Modo de Transporte</label>
          <select class="form-select" name="transport_mode">
            <option value="driving">Carro</option>
            <option value="walking">Caminhada</option>
            <option value="bicycling">Bicicleta</option>
            <option value="transit">Transp. Público</option>
          </select>
        </div>

        <!-- Tipo de Viagem -->
        <div class="mb-3">
          <label class="form-label">Tipo de Viagem</label>
          <select class="form-select" name="trip_type">
            <option value="turismo">Turismo Clássico</option>
            <option value="negocios">Negócios</option>
            <option value="lua_de_mel">Lua de Mel</option>
            <option value="aventura">Viagem de Aventura</option>
            <option value="gastronomica">Viagem Gastronômica</option>
          </select>
        </div>

        <!-- Locais de Interesse -->
        <div class="mb-3">
          <label for="interestPlaces" class="form-label">Locais de Interesse</label>
          <textarea class="form-control" id="interestPlaces" name="interest_places" rows="2"
                    placeholder="Ex: Ponto X, Museu Y, Parque Z"></textarea>
          <div class="form-text">
            Se já tiver alguma lista de locais que quer muito visitar, informe aqui.
          </div>
        </div>

        <!-- Extras -->
        <div class="mb-3">
          <label for="extras" class="form-label">Observações / Extras</label>
          <textarea class="form-control" id="extras" name="extras" rows="3"
                    placeholder="Ex: Acessibilidade, hospedagem 5 estrelas, etc."></textarea>
        </div>

        <div class="text-center">
          <button type="submit" class="btn btn-primary w-100 btn-lg shadow-sm">Gerar Roteiro</button>
        </div>
      </form>
    </div>

    {# =====================  PAINEL DIREITO  ===================== #}
    <div class="col-md-8 px-3 right-panel">
      <h3 class="mb-4 pt-3 text-white">Meus Itinerários</h3>

      {% if itineraries %}
      <div class="row p-3">
        {% for it in itineraries %}
        <div class="col-md-6 mb-4">
          <div class="card h-100 p-3" style="background-color:#2c2c2e;color:#fff;">
            <div class="card-body">
              <h3 class="card-title">{{ it.destination }}</h3>
              <p class="card-text">{{ it.start_date }} → {{ it.end_date }}</p>

              <div class="my-2">
                <form method="POST" action="{% url 'delete_itinerary' it.id %}" style="display:inline;">
                  {% csrf_token %}
                  <button class="btn btn-sm btn-outline-light" type="button"
                          data-bs-toggle="modal" data-bs-target="#modalIt{{ it.id }}">
                    Ver Detalhes
                  </button>
                  <a href="{% url 'export_itinerary_pdf' it.id %}"
                     class="btn btn-sm btn-outline-light">Baixar PDF</a>
                  <button type="submit" class="btn btn-sm btn-outline-danger"
                          onclick="return confirm('Tem certeza que deseja excluir este itinerário?')">
                    Excluir
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>

        {# ----------  MODAL DE DETALHES  ---------- #}
        <div class="modal fade" id="modalIt{{ it.id }}" tabindex="-1"
             aria-labelledby="modalItLabel{{ it.id }}" aria-hidden="true">
          <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content" style="background-color:#202023;color:#fff;">
              <div class="modal-header">
                <h5 class="modal-title" id="modalItLabel{{ it.id }}">
                  {{ it.destination }} - {{ it.start_date }} → {{ it.end_date }}
                </h5>
                <button type="button" class="btn-close btn-close-white"
                        data-bs-dismiss="modal" aria-label="Close"></button>
              </div>

              <div class="modal-body">
                <h5>Overview</h5>
                <div class="ai-text mb-3">{{ it.generated_text|markdownify }}</div>

                <h5>Days</h5>
                <ul class="nav nav-tabs mt-3" id="daysTab{{ it.id }}" role="tablist">
                  {% for d in it.days.all|dictsort:"day_number" %}
                  <li class="nav-item" role="presentation">
                    <button class="nav-link {% if forloop.first %}active{% endif %}"
                            id="day{{ it.id }}-{{ d.id }}-tab"
                            data-bs-toggle="tab" data-bs-target="#day{{ it.id }}-{{ d.id }}"
                            type="button" role="tab">
                      Dia {{ d.day_number }}
                    </button>
                  </li>
                  {% endfor %}
                </ul>

                <div class="tab-content mt-3" id="daysTabContent{{ it.id }}">
                  {% for d in it.days.all|dictsort:"day_number" %}
                  <div class="tab-pane fade {% if forloop.first %}show active{% endif %}"
                       id="day{{ it.id }}-{{ d.id }}" role="tabpanel">
                    <div class="result-card mb-3">
                      <div class="ai-text">{{ d.generated_text|markdownify|safe }}</div>

                      {% if d.places_visited %}
                      <div class="mt-3">
                        <strong>Lugares (Editar individualmente):</strong>
                        <div id="day-places-{{d.id}}"></div>
                        <script>
                          (function(){
                            const container = document.getElementById("day-places-{{d.id}}");
                            const rawData = `{{ d.places_visited|safe }}`;
                            try {
                              const arr = JSON.parse(rawData);
                              if (Array.isArray(arr)) {
                                let html = "";
                                arr.forEach((p, idx) => {
                                  const placeName = p.name || "Local desconhecido";
                                  html += `
                                    <div class="mt-2">
                                      ${idx+1}. ${placeName}
                                      <button class="btn btn-sm btn-link text-warning replace-place-btn"
                                              data-dayid="{{d.id}}" data-index="${idx}"
                                              data-bs-toggle="modal" data-bs-target="#replaceModal">
                                        🔄
                                      </button>
                                    </div>`;
                                });
                                container.innerHTML = html;
                              }
                            } catch(e){}
                          })();
                        </script>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  {% endfor %}
                </div>

                <h5>Map</h5>
                <div id="map{{ it.id }}"
                     data-lat="{{ it.lat|floatformat:'6' }}"
                     data-lng="{{ it.lng|floatformat:'6' }}"
                     data-markers='{{ it.markers_json|escape }}'
                     style="height:400px;border:1px solid #3a3a3c;border-radius:6px;"></div>
              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-outline-light"
                        data-bs-dismiss="modal">Fechar</button>
              </div>
            </div>
          </div>
        </div>
        {# ----------  /MODAL  ---------- #}
        {% endfor %}
      </div>
      {% else %}
      <p class="text-white">Nenhum itinerário criado ainda...</p>
      {% endif %}
    </div>
  </div>
</div>

{# ------------------  MODAL TROCA DE LUGAR  ------------------ #}
<div class="modal fade" id="replaceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" style="color:#fff;">
    <div class="modal-content" style="background-color:#202023;">
      <div class="modal-header">
        <h5 class="modal-title">Trocar Lugar</h5>
        <button type="button" class="btn-close btn-close-white"
                data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{% url 'replace_place' %}">
        {% csrf_token %}
        <div class="modal-body">
          <input type="hidden" id="replaceDayId" name="day_id">
          <input type="hidden" id="replaceIndex" name="place_index">
          <div class="mb-3">
            <label for="replaceObservation" class="form-label">
              Observação / Preferência para o novo local
            </label>
            <textarea class="form-control" id="replaceObservation" name="observation"
                      rows="3" placeholder="Ex: Quero algo mais central, sem repetir lugares ou com comida típica"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-light"
                  data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Confirmar Troca</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function initAutocomplete() {
  console.log("[initAutocomplete] Chamado: Autocomplete configurado no campo de destino.");

  const destInput = document.getElementById("destination");
  if (destInput) {
    const autocomplete = new google.maps.places.Autocomplete(destInput, { types: ['(cities)'] });
  }

  // inicializa mapas quando o modal abre
  document.querySelectorAll('.modal.fade').forEach(modal => {
    modal.addEventListener('shown.bs.modal', () => {
      const id = modal.getAttribute('id');
      if (id && id.startsWith("modalIt")) {
        const itineraryId = id.replace('modalIt','');
        initMultipleMarkers(itineraryId);
      }
    });
  });
}

function initMultipleMarkers(itineraryId) {
  const mapDiv = document.getElementById("map" + itineraryId);
  if (!mapDiv) return;

  const rawMarkers = mapDiv.dataset.markers;
  if (!rawMarkers) return;

  let markers = [];
  try { markers = JSON.parse(rawMarkers); }
  catch(e){ console.error("[initMultipleMarkers] JSON inválido:", e); return; }

  if (!markers.length) return;

  let lat = parseFloat(mapDiv.dataset.lat);
  let lng = parseFloat(mapDiv.dataset.lng);
  if (isNaN(lat) || isNaN(lng)) { lat = markers[0].lat; lng = markers[0].lng; }

  const map = new google.maps.Map(mapDiv, { zoom: 12, center: {lat, lng} });
  const bounds = new google.maps.LatLngBounds();

  markers.forEach(m => {
    if (m.lat && m.lng) {
      const pos = {lat: m.lat, lng: m.lng};
      new google.maps.Marker({ position: pos, map, title: m.name });
      bounds.extend(pos);
    }
  });

  if (markers.length > 1) map.fitBounds(bounds);
}

document.addEventListener("DOMContentLoaded", () => {
  const autoOpenId = "{{ new_itinerary_id|default:'' }}";
  if (autoOpenId) {
    const modalEl = document.getElementById("modalIt" + autoOpenId);
    if (modalEl) new bootstrap.Modal(modalEl).show();
  }

  document.body.addEventListener("click", e => {
    if (e.target && e.target.classList.contains("replace-place-btn")) {
      document.getElementById("replaceDayId").value = e.target.dataset.dayid;
      document.getElementById("replaceIndex").value = e.target.dataset.index;
      document.getElementById("replaceObservation").value = "";
    }
  });
});
</script>

<script src="https://maps.googleapis.com/maps/api/js?key={{ googlemaps_key }}&libraries=places&callback=initAutocomplete" async defer></script>
{% endblock %}
