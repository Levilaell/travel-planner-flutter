{% extends 'base.html' %}
{% load markdownify %}

{% block content %}
<h2>Detalhes do Itinerário</h2>

<div>
  <strong>Destino:</strong> {{ itinerary.destination }}<br>
  ...
</div>

<h4>Texto Geral (IA) - Overview:</h4>
<div>
  {{ itinerary.generated_text|markdownify }}
</div>

<hr>

<h3>Roteiro - Dia a Dia</h3>
{% for day in days %}
  <div class="my-4 p-3 border">
    <h5>Dia {{ day.day_number }} - {{ day.date }}</h5>

    {% if day.generated_text %}
      <div class="mb-2">
        {{ day.generated_text|markdownify|linebreaksbr }}
      </div>
    {% else %}
      <p>Nenhum roteiro gerado para este dia.</p>
    {% endif %}

    <!-- Transform day.places_visited (JSON) em var JavaScript -->
    {% if day.places_visited %}
      {% with places=day.places_visited|safe %}
        <script>
          var day{{ day.id }}Places = {{ places }};
        </script>
      {% endwith %}
    {% else %}
      <script>
        var day{{ day.id }}Places = [];
      </script>
    {% endif %}

    <!-- Div do mapa específico deste dia -->
    <div id="map-day-{{ day.id }}" style="width:100%; height:300px; background:#eee;"></div>
  </div>
{% endfor %}
{% endblock %}

{% block extra_scripts %}
<script>
  function initAllMaps() {
    {% for day in days %}
      var places = window["day{{ day.id }}Places"] || [];
      if (places.length > 0) {
        let latSum = 0, lngSum = 0;
        places.forEach(p => {
          latSum += parseFloat(p.lat);
          lngSum += parseFloat(p.lng);
        });
        let centerLat = latSum / places.length;
        let centerLng = lngSum / places.length;

        let mapDivId = "map-day-{{ day.id }}";
        let mapOptions = {
          zoom: 13,
          center: { lat: centerLat, lng: centerLng }
        };
        let map = new google.maps.Map(document.getElementById(mapDivId), mapOptions);

        // Marcadores
        places.forEach(p => {
          new google.maps.Marker({
            position: { lat: parseFloat(p.lat), lng: parseFloat(p.lng) },
            map: map,
            title: p.name
          });
        });
      }
    {% endfor %}
  }
</script>

<!-- Carrega a API do Google Maps -->
<script async
  src="https://maps.googleapis.com/maps/api/js?key={{ googlemaps_key }}&callback=initAllMaps">
</script>
{% endblock %}
