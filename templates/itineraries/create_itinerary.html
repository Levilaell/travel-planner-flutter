{% extends "base.html" %}
{% load static %}
{% load markdownify %}

{% block content %}

<div class="container-fluid">
  <div class="row full-height-row">

    <!-- Painel Esquerdo (30%) - Formulário -->
    <div class="col-md-4 left-panel d-flex align-items-start flex-column">
      <h3 class="mt-3">Criar Novo Itinerário</h3>

      {% if form.errors %}
        <div class="alert alert-danger w-100">
          <ul class="mb-0">
            {% for field, errors in form.errors.items %}
              {% for error in errors %}
                <li><strong>{{ field }}:</strong> {{ error }}</li>
              {% endfor %}
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      <!-- Formulário -->
      <form method="POST" action="{% url 'create_itinerary' %}" class="w-100">
        {% csrf_token %}
        <div class="row g-3">
          <!-- Destino -->
          <div class="col-12">
            <label for="destination" class="form-label">Destino</label>
            <input type="text" class="form-control" id="destination" 
                   name="destination" placeholder="Ex: Natal, Brasil" required>
          </div>

          <!-- Data de Início -->
          <div class="col-6">
            <label for="startDate" class="form-label">Data de Início</label>
            <input type="date" class="form-control" id="startDate" 
                   name="start_date" required>
          </div>

          <!-- Data de Término -->
          <div class="col-6">
            <label for="endDate" class="form-label">Data de Término</label>
            <input type="date" class="form-control" id="endDate" 
                   name="end_date" required>
          </div>

          <!-- Orçamento -->
          <div class="col-12">
            <label for="budget" class="form-label">Orçamento Estimado (R$)</label>
            <input type="number" step="0.01" class="form-control" 
                   id="budget" name="budget" placeholder="Ex: 2000" required>
          </div>

          <!-- Número de Viajantes -->
          <div class="col-12">
            <label for="travelers" class="form-label">Número de Viajantes</label>
            <input type="number" class="form-control" 
                   id="travelers" name="travelers" min="1" value="1">
          </div>

          <!-- Interesses -->
          <div class="col-12">
            <label class="form-label d-block">Interesses Principais</label>
            <div class="d-flex flex-wrap gap-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" 
                       id="interestCultura" name="interests_list" value="Cultura">
                <label class="form-check-label" for="interestCultura">Cultura</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" 
                       id="interestGastronomia" name="interests_list" value="Gastronomia">
                <label class="form-check-label" for="interestGastronomia">Gastronomia</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" 
                       id="interestAventura" name="interests_list" value="Aventura">
                <label class="form-check-label" for="interestAventura">Aventura</label>
              </div>
            </div>
          </div>

          <!-- Preferência de Alimentação -->
          <div class="col-12">
            <label for="foodPreferences" class="form-label">Preferência de Alimentação</label>
            <select class="form-select" id="foodPreferences" name="food_preferences">
              <option value="nenhuma">Nenhuma Restrição</option>
              <option value="vegana">Vegana</option>
              <option value="vegetariana">Vegetariana</option>
              <option value="kosher">Kosher</option>
              <option value="halal">Halal</option>
            </select>
          </div>

          <!-- Extras -->
          <div class="col-12">
            <label for="extras" class="form-label">Extras e Personalização</label>
            <textarea class="form-control" id="extras" name="extras" rows="3"
                      placeholder="Ex: Preciso de acessibilidade, viajo com crianças..."></textarea>
          </div>

          <!-- Transporte -->
          <div class="col-12">
            <label class="form-label">Modo de Transporte Preferido</label>
            <select class="form-select" name="transport_mode">
              <option value="driving">Carro</option>
              <option value="walking">Caminhada</option>
              <option value="bicycling">Bicicleta</option>
              <option value="transit">Transporte Público</option>
            </select>
          </div>

          <!-- Locais de Interesse -->
          <div class="col-12">
            <label for="interestPlaces" class="form-label">Locais de Interesse (opcional)</label>
            <textarea class="form-control" id="interestPlaces" name="interest_places" rows="3"
                      placeholder="Ex: Quero conhecer o Museu X, a Praia Y..."></textarea>
          </div>

          <div class="col-12 text-center">
            <button type="submit" class="btn btn-primary w-100 btn-lg shadow-sm">
              Gerar Roteiro
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- Painel Direito (70%) -->
    <div class="col-md-8 right-panel">
      {% if itinerary %}
        <!-- 1) Info geral do itinerário -->
        <div class="result-card mb-3">
          <h3 class="mb-3">Roteiro Gerado</h3>
          <p class="fs-1"><strong>Destino:</strong> {{ itinerary.destination }}</p>
          <p class="fs-1"><strong>Data Inicial:</strong> {{ itinerary.start_date }}</p>
          <p class="fs-1"><strong>Data Final:</strong> {{ itinerary.end_date }}</p>
          <p class="fs-1"><strong>Orçamento:</strong> {{ itinerary.budget }}</p>
          <p class="fs-1"><strong>Viajantes:</strong> {{ itinerary.travelers }}</p>
          <p class="fs-1"><strong>Interesses:</strong> {{ itinerary.interests }}</p>
          <p class="fs-1"><strong>Preferências de alimentação:</strong> {{ itinerary.food_preferences }}</p>
          <p class="fs-1"><strong>Extras:</strong> {{ itinerary.extras }}</p>
          <p class="fs-1"><strong>Modo de transporte:</strong> {{ itinerary.transport_mode }}</p>
          <p class="fs-1"><strong>Lugares de interesse:</strong> {{ itinerary.interest_places }}</p>
        </div>

        <!-- 2) Texto Geral da IA (overview) -->
        <div class="result-card mb-3">
          <h4>Texto Geral:</h4>
          <div class="ai-text montserrat">{{ itinerary.generated_text|markdownify }}
          </div>
        </div>

        <!-- 3) Loop pelos dias do itinerário -->
        {% for day in days %}
          <div class="result-card mb-3">
            <h4>Dia {{ day.day_number }} - {{ day.date|date:"d/m/Y" }}</h4>
            <div class="ai-text montserrat">{{ day.generated_text|markdownify|safe }}
            </div>
          </div>
        {% endfor %}

        <!-- 4) Mapa (opcional) se tiver lat/lng -->
        {% if lat and lng %}
        <div class="result-card mb-3">
          <h5>Localização no Mapa</h5>
          <div id="map" style="height:400px;"></div>
        </div>

        <!-- SCRIPT para exibir vários marcadores -->
        <script>
          function initMap() {
            // Coordenadas do destino (usadas como centro padrão)
            const centerCoords = { 
              lat: parseFloat('{{ lat }}'), 
              lng: parseFloat('{{ lng }}') 
            };
            const map = new google.maps.Map(document.getElementById("map"), {
              zoom: 12,
              center: centerCoords,
            });

            // Se existe markers_json, criamos vários marcadores
            {% if markers_json %}
              const markersData = JSON.parse('{{ markers_json|safe }}');
              // Para ajustar o zoom de acordo com todos os pontos
              const bounds = new google.maps.LatLngBounds();

              markersData.forEach(place => {
                // Verifica se place.lat e place.lng existem
                if (place.lat && place.lng) {
                  // Converter para float
                  const position = { 
                    lat: parseFloat(place.lat), 
                    lng: parseFloat(place.lng) 
                  };
                  // Cria marcador
                  new google.maps.Marker({
                    position: position,
                    map: map,
                    title: place.name || "Local"
                  });
                  // Extende o bounds para esse ponto
                  bounds.extend(position);
                }
              });

              // Se tivermos pelo menos 1 lugar na lista, ajusta o mapa
              if (markersData.length > 0) {
                map.fitBounds(bounds);
              }
            {% else %}
              // Caso não tenha markers_json, podemos criar somente 1 marcador do destino principal
              new google.maps.Marker({
                position: centerCoords,
                map: map,
                title: "Destino: {{ itinerary.destination }}"
              });
            {% endif %}
          }
        </script>
        <script async
          src="https://maps.googleapis.com/maps/api/js?key={{ googlemaps_key }}&callback=initMap">
        </script>
        {% endif %}

        <!-- 5) Botão voltar -->
        <a href="{% url 'list_itineraries' %}" class="btn btn-secondary mt-3">
          Voltar aos meus roteiros
        </a>

      {% else %}
        <!-- Se ainda não gerou itinerário -->
        <div class="text-center text-secondary mt-5">
          <h4>Nenhum itinerário ainda...</h4>
          <p>Preencha o formulário à esquerda para gerar um novo roteiro!</p>
        </div>
      {% endif %}
    </div>

  </div>
</div>

{% endblock %}
